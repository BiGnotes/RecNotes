name: Build Android APK

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build Debug APK
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          SILICON_FLOW_API_KEY: ${{ secrets.SILICON_FLOW_API_KEY }}
        run: ./gradlew assembleDebug

      - name: Upload APK to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/app-debug.apk

      - name: Upload APK to WebDAV and Cleanup
        if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
        env:
          WEBDAV_URL: 'https://alist.ranotes.com:4433/dav/Android%20App/'
          WEBDAV_USERNAME: 'claw'
          WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
        run: |
          # 1. Define file name with timestamp and commit hash
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          SHORT_SHA=$(git rev-parse --short HEAD)
          FILE_NAME="RecNotes_debug_${TIMESTAMP}_${SHORT_SHA}.apk"
          FILE_PATH="app/build/outputs/apk/debug/app-debug.apk"
          
          echo "Uploading $FILE_PATH to $WEBDAV_URL$FILE_NAME ..."
          
          if [ -z "$WEBDAV_PASSWORD" ]; then
            echo "Error: WEBDAV_PASSWORD secret is not set!"
            exit 1
          fi
          
          # 2. Upload via curl
          echo "Uploading via WebDAV..."
          if ! curl -f -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" -T "$FILE_PATH" "$WEBDAV_URL$FILE_NAME"; then
            echo "::error::Upload failed (curl returned error)"
            exit 1
          fi

          # 3. Verify Upload (Check Content-Length)
          echo "Verifying upload integrity..."
          LOCAL_SIZE=$(stat -c%s "$FILE_PATH")
          # Get remote size. Use -I for HEAD request, grep Content-Length, extract value
          REMOTE_SIZE=$(curl -sI -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" "$WEBDAV_URL$FILE_NAME" | grep -i "Content-Length" | awk '{print $2}' | tr -d '\r')
          
          echo "Local size: $LOCAL_SIZE bytes"
          echo "Remote size: $REMOTE_SIZE bytes"

          # Basic check: if REMOTE_SIZE is empty or doesn't match, fail
          if [ -z "$REMOTE_SIZE" ]; then
             echo "::warning::Could not fetch remote Content-Length. Assuming upload OK but unverified."
          elif [ "$LOCAL_SIZE" != "$REMOTE_SIZE" ]; then
            echo "::error::Upload verification failed! Size mismatch (Local: $LOCAL_SIZE vs Remote: $REMOTE_SIZE)."
            # Attempt to delete the corrupted file so we don't accidentally download a bad one
            curl -s -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" -X DELETE "$WEBDAV_URL$FILE_NAME"
            exit 1
          else
             echo "Verification successful: Sizes match."
          fi
          
          echo "Starting cleanup..."

          # 3. List files, sort by time (assuming filename format helps or WebDAV property), and delete old ones
          # Since WebDAV listing can be tricky with curl/grep/xml, we rely on the consistent naming: RecNotes_debug_YYYYMMDD_HHMMSS_SHA.apk
          # We will fetch the file list, filter for our APKs, sort reverse (newest first), skip top 3, and delete the rest.
          
          # Fetch file list (PROPFIND)
          # Note: Parsing XML with grep/sed is fragile but often sufficient for simple lists.
          # We look for <D:href>.../Android%20App/RecNotes_debug_...</D:href>
          
          FILES=$(curl -s -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" -X PROPFIND "$WEBDAV_URL" --header "Depth: 1" | \
            grep -oE '/dav/Android%20App/RecNotes_debug_[0-9]{8}_[0-9]{6}_[a-f0-9]+\.apk' | \
            sort -r)
          
          echo "Found files:"
          echo "$FILES"
          
          # Count files
          COUNT=$(echo "$FILES" | wc -l)
          echo "Total APKs found: $COUNT"
          
          if [ "$COUNT" -gt 3 ]; then
            # Get files to delete (skip first 3)
            DELETE_LIST=$(echo "$FILES" | tail -n +4)
            
            for REMOTE_FILE in $DELETE_LIST; do
              # Construct full delete URL. The REMOTE_FILE path from grep includes /dav/Android%20App/...
              # We need to be careful with URL construction. 
              # The WEBDAV_URL is https://alist.ranotes.com:4433/dav/Android%20App/
              # The REMOTE_FILE is /dav/Android%20App/RecNotes_debug_...
              # So we can just append the domain part.
              
              DELETE_URL="https://alist.ranotes.com:4433${REMOTE_FILE}"
              echo "Deleting old version: $DELETE_URL"
              curl -s -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" -X DELETE "$DELETE_URL"
            done
          else
            echo "No cleanup needed (<= 3 versions)."
          fi
