name: Build Android APK

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build Debug APK
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: ./gradlew assembleDebug

      - name: Upload APK to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/app-debug.apk

      - name: Upload APK to WebDAV
        if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
        env:
          WEBDAV_URL: 'https://alist.ranotes.com:4433/dav/Android%20App/'
          WEBDAV_USERNAME: 'claw'
          WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
        run: |
          # Define file name with commit hash for uniqueness
          SHORT_SHA=$(git rev-parse --short HEAD)
          FILE_NAME="RecNotes-debug-${SHORT_SHA}.apk"
          FILE_PATH="app/build/outputs/apk/debug/app-debug.apk"
          
          echo "Uploading $FILE_PATH to $WEBDAV_URL$FILE_NAME ..."
          
          if [ -z "$WEBDAV_PASSWORD" ]; then
            echo "Error: WEBDAV_PASSWORD secret is not set!"
            exit 1
          fi
          
          # Upload via curl
          curl -v -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" -T "$FILE_PATH" "$WEBDAV_URL$FILE_NAME"
